# Royalties Ledger

This directory contains the **append-only ledger** tracking all royalty accruals and payouts in the IDEALE.eu system.

## Files

* **`royalties/ledger.jsonl`** — JSON Lines file; **one JSON object per line**, newest entries appended at the end.

---

## Entry Types

* `ROYALTY_ACCRUE` — accrual generated by events (e.g., PR, merge, reuse, anchor, verify, derivative).
* `ROYALTY_PAYOUT` — settlement records aggregated and paid to recipients.

---

## `ROYALTY_ACCRUE` — Schema

```json
{
  "ts": "2025-10-05T18:20:15Z",
  "type": "ROYALTY_ACCRUE",
  "artifact_hash": "sha256:1234567890abcdef...",
  "event": "PR_MERGE",
  "declared_value_eur": 10000.0,
  "fee_bps": 10,
  "fee_eur": 10.0,
  "split": {
    "creators_eur": 6.0,
    "validators_eur": 2.3,
    "infra_eur": 1.5,
    "treasury_eur": 0.2
  },
  "allocations": [
    { "id": "did:github:alice", "share_bps": 6000, "amount_eur": 3.6 },
    { "id": "did:github:bob",   "share_bps": 4000, "amount_eur": 2.4 }
  ],
  "meta": [
    {
      "id": "ideale://standards/artifact.schema.v0.1",
      "version": "0.1.0",
      "weight": 1.0,
      "amount_eur": 0.882353,
      "payout": { "tt": "creator/ideale-core", "iban": null }
    }
  ]
}
```

**Notes**

* `fee_eur` = `declared_value_eur × (fee_bps / 10_000)`.
* `split.*` values are computed from `fee_eur` using the distribution in `config/royalties.json`.
* `allocations` breaks down the **creators** portion among individual contributors by basis points of the *creators share* (not of the artifact value).
* `meta` optionally captures infra/tooling/meta-assets attribution (schemas, workflows, adapters, assistants) with weights and payout routing.

---

## `ROYALTY_PAYOUT` — Schema

```json
{
  "ts": "2025-10-31T12:00:00Z",
  "type": "ROYALTY_PAYOUT",
  "recipient_id": "did:github:alice",
  "amount_eur": 142.35,
  "period_start": "2025-10-01",
  "period_end": "2025-10-31",
  "transaction_id": "bank:SEPA:2025-10-31:XYZ123",
  "channel": "TT",               // e.g., TT, IBAN, on-chain, etc.
  "details": { "memo": "Cycle #10" }
}
```

**Notes**

* Payouts are produced by aggregating accrual lines within a period and applying policy thresholds (see `config/royalties.json`).

---

## Examples (single-line JSON)

**Accrual**

```json
{"ts":"2025-10-04T12:00:00Z","type":"ROYALTY_ACCRUE","artifact_hash":"sha256:…","event":"reuse","declared_value_eur":10000,"fee_bps":10,"fee_eur":10,"split":{"creators_eur":6,"validators_eur":2.3,"infra_eur":1.5,"treasury_eur":0.2},"allocations":[{"id":"did:github:alice","share_bps":7000,"amount_eur":4.2},{"id":"did:github:bob","share_bps":3000,"amount_eur":1.8}]}
```

**Payout**

```json
{"ts":"2025-10-31T12:00:00Z","type":"ROYALTY_PAYOUT","recipient_id":"did:github:alice","amount_eur":142.35,"period_start":"2025-10-01","period_end":"2025-10-31","transaction_id":"bank:SEPA:2025-10-31:XYZ123","channel":"TT","details":{"memo":"Cycle #10"}}
```

---

## Viewing & Summaries (CLI)

Pretty-print all entries:

```bash
cat royalties/ledger.jsonl | jq '.'
```

Quick summary (ts, event/type, fee or amount):

```bash
cat royalties/ledger.jsonl | jq -r '
  if .type=="ROYALTY_ACCRUE" then
    [ .ts, .event, (.fee_eur|tostring) ] | @tsv
  else
    [ .ts, .type, (.amount_eur|tostring) ] | @tsv
  end
' | column -t
```

Total fees accrued:

```bash
cat royalties/ledger.jsonl | jq -s 'map(select(.type=="ROYALTY_ACCRUE") | .fee_eur) | add'
```

Total infra earnings:

```bash
cat royalties/ledger.jsonl | jq -s 'map(select(.type=="ROYALTY_ACCRUE") | .split.infra_eur) | add'
```

Filter accruals by event:

```bash
cat royalties/ledger.jsonl | jq 'select(.type=="ROYALTY_ACCRUE" and .event=="PR_MERGE")'
```

Earnings by creator (from allocations):

```bash
cat royalties/ledger.jsonl | jq -s '
  [ .[] | select(.type=="ROYALTY_ACCRUE") | .allocations[] ] |
  group_by(.id) |
  map({ id: .[0].id, total: (map(.amount_eur) | add) })
'
```

---

## Guarantees

1. **Append-only** — entries are never edited or removed.
2. **Immutable** — every record stands alone and is permanent.
3. **Traceable** — each accrual links to a specific `artifact_hash`.
4. **Timestamped** — all entries use ISO-8601 UTC timestamps.
5. **Transparent** — complete distribution and allocations logged.

---

## Automation

The ledger is updated by:

* **GitHub Actions** (accrual preview on PRs; commits on `main`)
* **Manual accruals** via `scripts/accrue_royalty.py`

See: [`../.github/workflows/royalties-accrual.yml`](../.github/workflows/royalties-accrual.yml)

---

## File Format

* **JSON Lines** (`.jsonl`): one valid JSON object per line; newline-delimited.
* Chronological order (oldest → newest).
* No trailing commas; no array wrappers.
* Suited for streaming and large ledgers.

---

## Backup & Archival

* Include in repository backups.
* Track in Git for diffable history.
* Periodically archive for compliance.

---

## Payout Processing (overview)

1. Select a payout period.
2. Aggregate accruals by recipient.
3. Apply thresholds/policies from `config/royalties.json`.
4. Execute payments (TT/IBAN/on-chain).
5. Append `ROYALTY_PAYOUT` lines with references.

Roadmap for automated payouts is in **[README-ROYALTIES.md](../README-ROYALTIES.md)**.

---

## See Also

* [`../scripts/accrue_royalty.py`](../scripts/accrue_royalty.py) — accrual engine
* [`../config/royalties.json`](../config/royalties.json) — distribution & policy
* [`../README-ROYALTIES.md`](../README-ROYALTIES.md) — full system docs

---

